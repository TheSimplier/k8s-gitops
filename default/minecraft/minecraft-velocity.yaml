---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velocity
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: minecraft-proxy
      version: 3.7.0
      sourceRef:
        kind: HelmRepository
        name: minecraft-server-charts
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: itzg/bungeecord
      tag: 2024.6.0
    podSecurityContext:
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      fsGroup: 1000
    resources:
      requests:
        memory: 250Mi
        cpu: 50m
      limits:
        memory: 500Mi
    podAnnotations:
      configmap.reloader.stakater.com/reload: "velocity-minecraft-proxy-config"
    # extraEnv:
    #   SPIGET_PLUGINS: "78915,75"
    minecraftProxy:
      type: velocity
      # A list of .jar URLs to download into the plugins folder.
      # plugins: []
      serviceType: LoadBalancer
      externalTrafficPolicy: Cluster
      configFilePath: /server/velocity.toml
    extraVolumes:
      - volumeMounts:
        - name: velocity-config
          mountPath: /server/velocity.toml
          subPath: velocity.toml
          readOnly: true
        volumes:
          - name: velocity-config
            configMap:
              name: velocity-configmap
              items:
                - key: velocity.toml
                  path: velocity.toml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: velocity-configmap
  namespace: default
data:
  velocity.toml: |
    motd = "<#09add3>eviljungle"
    player-info-forwarding-mode = "modern"
    [servers]
    lobby = "mc-lobby-minecraft:25565"
    creative = "mc-minecraft:25565"
    survival = "mcsv-minecraft:25565"
    survival2 = "mcsv2-minecraft:25565"

    # In what order we should try servers when a player logs in or is kicked from a server.
    try = [
        "lobby"
    ]
